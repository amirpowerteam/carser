<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ù¾Ø®Ø´â€ŒÚ©Ù†Ù†Ø¯Ù‡ â€” Ú©ØªØ§Ø¨â€ŒØ¬ÛŒØ¨ÛŒ</title>
    <meta name="description" content="Ù¾Ø®Ø´â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø§Ù¾ÛŒØ²ÙˆØ¯ Ù¾Ø§Ø¯Ú©Ø³Øª Ú©ØªØ§Ø¨â€ŒØ¬ÛŒØ¨ÛŒ">
    <meta property="og:title" content="Ú©ØªØ§Ø¨â€ŒØ¬ÛŒØ¨ÛŒ â€” Ù¾Ø®Ø´â€ŒÚ©Ù†Ù†Ø¯Ù‡">
    <meta property="og:description" content="Ù¾Ø®Ø´â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø§Ù¾ÛŒØ²ÙˆØ¯ Ù¾Ø§Ø¯Ú©Ø³Øª Ú©ØªØ§Ø¨â€ŒØ¬ÛŒØ¨ÛŒ">
    <meta property="og:image" content="/placeholder.svg">
    <meta property="og:type" content="music.song">
    <link rel="stylesheet" href="/styles.css">
    <style>
      body.player-page { min-height:100vh; display:flex; align-items:center; justify-content:center; }
      .player-wrap { position:relative; width:100%; height:100vh; color:#fff; }
      .player-bg { position:absolute; inset:0; background-size:cover; background-position:center; filter:blur(4px); }
      .player-ui { position:relative; z-index:2; max-width:900px; margin:0 auto; padding:24px; display:flex; flex-direction:column; align-items:center; gap:18px; }
      .player-card { background:rgba(0,0,0,0.45); padding:18px; border-radius:12px; width:100%; display:flex; align-items:center; gap:12px; }
      .player-card .meta { flex:1; }
      .player-controls { display:flex; gap:8px; align-items:center; }
      .cover-upload { margin-top:8px; }
      .player-progress { width:100%; appearance:none; height:6px; background:rgba(255,255,255,0.2); border-radius:6px; }
    </style>
  </head>
  <body class="player-page">
    <div class="player-wrap">
      <div id="playerBg" class="player-bg"></div>
      <button id="themeToggle" class="theme-toggle" title="ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª Ø±ÙˆØ²/Ø´Ø¨" style="position:fixed;top:12px;left:12px;z-index:999">ğŸŒ™</button>
      <div class="player-ui">
        <h2 id="title">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</h2>
        <img id="coverPreview" alt="cover preview" style="max-width:160px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.5);display:none;" />
        <div class="player-card">
          <div class="meta">
            <div id="desc">â€”</div>
            <div style="margin-top:8px">
              <input id="seek" type="range" min="0" max="100" value="0" class="player-progress">
            </div>
          </div>
          <div class="player-controls">
            <button id="playBtn">â–¶</button>
            <div id="time">00:00 / 00:00</div>
          </div>
        </div>

        <div class="cover-upload">
          <label>Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØµÙˆÛŒØ± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø§Ù¾ÛŒØ²ÙˆØ¯ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯:</label>
          <form id="coverForm" enctype="multipart/form-data">
            <input type="file" name="cover" accept="image/*">
            <input type="hidden" name="id" id="itemId">
            <button type="submit">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡</button>
          </form>
          <div id="coverMsg" style="margin-top:8px"></div>
        </div>
      </div>
      <audio id="player" preload="metadata"></audio>
    </div>

    <script>
      function q(sel){ return document.querySelector(sel); }
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      const player = q('#player');
      const playBtn = q('#playBtn');
      const titleEl = q('#title');
      const descEl = q('#desc');
      const bg = q('#playerBg');
      const coverPreview = q('#coverPreview');
      const seek = q('#seek');
      const timeEl = q('#time');
      const coverForm = q('#coverForm');
      const coverMsg = q('#coverMsg');
      q('#itemId').value = id || '';

      async function loadItem(){
        if(!id){ titleEl.textContent = 'Ø¢ÛŒØªÙ… Ù†Ø§Ù…Ø´Ø®Øµ'; return }
        try{
          const res = await fetch('/api/uploads');
          const items = await res.json();
          const it = items.find(x => String(x.id)===String(id));
          if(!it){ titleEl.textContent = 'Ù…ÙˆØ±Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯'; return }
          titleEl.textContent = it.title || 'Ø§Ù¾ÛŒØ²ÙˆØ¯';
          descEl.textContent = it.description || (it.textContent||'');
          // set background: prefer cover, then if mime image use file, else use a neutral gradient
          if(it.cover){ bg.style.backgroundImage = `url('${it.cover}')`; coverPreview.src = it.cover; coverPreview.style.display = 'block'; }
          else if(it.mime && it.mime.startsWith('image/') && it.file){ bg.style.backgroundImage = `url('${it.file}')`; coverPreview.src = it.file; coverPreview.style.display = 'block'; }
          else { bg.style.background = 'linear-gradient(120deg,#2b2b2b,#111827)'; coverPreview.style.display = 'none'; }
          if(it.file && it.mime && it.mime.startsWith('audio')){
            player.src = it.file;
          }
          // update dynamic meta/title
          try{
            document.title = `${it.title || 'Ø§Ù¾ÛŒØ²ÙˆØ¯'} â€” Ú©ØªØ§Ø¨â€ŒØ¬ÛŒØ¨ÛŒ`;
            const setMeta = (name, value, prop=false)=>{
              const sel = prop ? `meta[property="${name}"]` : `meta[name="${name}"]`;
              let m = document.querySelector(sel);
              if(!m){ m = document.createElement('meta'); if(prop) m.setAttribute('property', name); else m.setAttribute('name', name); document.head.appendChild(m); }
              m.setAttribute('content', value);
            };
            setMeta('description', it.description || it.textContent || 'Ø§Ù¾ÛŒØ²ÙˆØ¯ Ø§Ø² Ú©ØªØ§Ø¨â€ŒØ¬ÛŒØ¨ÛŒ');
            setMeta('og:title', it.title || 'Ú©ØªØ§Ø¨â€ŒØ¬ÛŒØ¨ÛŒ â€” Ø§Ù¾ÛŒØ²ÙˆØ¯', true);
            setMeta('og:description', it.description || it.textContent || '', true);
            setMeta('og:image', it.cover || (it.mime && it.mime.startsWith('image/') ? it.file : '/placeholder.svg'), true);
          }catch(e){}
        }catch(e){ console.error(e); titleEl.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø²Ø§Ø±ÛŒ'; }
      }

      playBtn.addEventListener('click', ()=>{
        if(!player.src) return;
        if(player.paused){ player.play(); playBtn.textContent = 'â¸'; }
        else { player.pause(); playBtn.textContent = 'â–¶'; }
      });

      player.addEventListener('loadedmetadata', ()=>{
        seek.max = Math.floor(player.duration);
        updateTime();
      });
      player.addEventListener('timeupdate', ()=>{ seek.value = Math.floor(player.currentTime); updateTime(); });

      seek.addEventListener('input', ()=>{ player.currentTime = Number(seek.value); });

      function fmt(s){ if(!isFinite(s)) return '00:00'; const m = Math.floor(s/60).toString().padStart(2,'0'); const sec = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; }
      function updateTime(){ timeEl.textContent = `${fmt(player.currentTime)} / ${fmt(player.duration)}`; }

      coverForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(coverForm);
        try{
          const res = await fetch('/api/attach-cover', { method:'POST', body: fd });
          const j = await res.json();
          if(j && j.success){ coverMsg.textContent = 'ØªØµÙˆÛŒØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.'; bg.style.backgroundImage = `url('${j.cover}')`; }
          else { coverMsg.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ±'; }
        }catch(err){ console.error(err); coverMsg.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±'; }
      });

      loadItem();

      // apply theme from localStorage and wire toggle on player page
      (function(){
        try{
          const t = localStorage.getItem('site-theme') || 'light';
          if(t === 'dark') document.documentElement.classList.add('dark-mode');
          const themeToggle = document.getElementById('themeToggle');
          if(themeToggle){ themeToggle.textContent = document.documentElement.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
            themeToggle.addEventListener('click', ()=>{
              const cur = document.documentElement.classList.contains('dark-mode') ? 'dark' : 'light';
              const next = cur === 'dark' ? 'light' : 'dark';
              if(next === 'dark') document.documentElement.classList.add('dark-mode'); else document.documentElement.classList.remove('dark-mode');
              themeToggle.textContent = next === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
              localStorage.setItem('site-theme', next);
            });
          }
        }catch(e){}
      })();
    </script>
  </body>
</html>
